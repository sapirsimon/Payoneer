trigger:
- '*'

pr:
- '*'

pool:
  name: 'HomeExam'

jobs:
- job: Build
  displayName: 'Build Docker Image'
  steps:
  - script: docker build -t counter-service .
    displayName: 'Build Docker Image'
    workingDirectory: $(Build.SourcesDirectory)

- job: Deploy
  displayName: 'Deploy Docker Container'
  dependsOn: Build
  steps:
  - script: |
      #Check if there is running container with name 'counter-service' and stop it and remove it
      docker ps -q --filter "name=counter-service" | grep -q . && docker stop counter-service && docker rm -fv counter-service
      #Run new container
      docker run -d -p 80:80 --name counter-service counter-service
      #Remove images which are not used by any container
      docker image prune -f
    displayName: 'Run Docker Container'
